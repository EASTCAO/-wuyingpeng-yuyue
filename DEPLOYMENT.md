# 部署和测试检查清单

## ✅ 已完成的工作

- [x] 后端代码迁移到 PostgreSQL
- [x] 添加环境变量支持
- [x] 更新 API 文档
- [x] 代码已推送到 GitHub
- [x] 创建测试脚本

## 📋 部署步骤

### 1. 在 Zeabur 部署后端

1. **访问 Zeabur 控制台**
   - 网址: https://zeabur.com
   - 进入你的项目（已有 PostgreSQL 数据库）

2. **添加后端服务**
   - 点击 "Add Service" → "Git"
   - 选择仓库: `EASTCAO/-wuyingpeng-yuyue`
   - 服务名称: `studio-booking-api`
   - 根目录: `api`

3. **连接数据库**
   - 进入后端服务设置
   - 点击 "Variables" 标签
   - 点击 "Connect to PostgreSQL"
   - 选择你的 PostgreSQL 服务（zeabur）
   - Zeabur 会自动注入 `DATABASE_URL`

4. **等待部署完成**
   - 查看部署日志，确认无错误
   - 应该看到 "数据库连接成功" 和 "数据表已就绪"

5. **获取后端域名**
   - 在服务页面找到域名
   - 复制完整 URL（例如：`https://xxx.zeabur.app`）

### 2. 配置前端

1. **更新 API 地址**
   ```bash
   # 编辑 app.js 第 16 行
   const API_BASE_URL = 'https://你的后端域名.zeabur.app';
   ```

2. **提交并推送**
   ```bash
   git add app.js
   git commit -m "Configure production backend URL"
   git push
   ```

3. **前端自动重新部署**
   - Zeabur 会自动检测到更新并重新部署前端

### 3. 测试后端 API

**方式一：使用测试脚本**
```bash
cd api
node test.js https://你的后端域名.zeabur.app
```

**方式二：手动测试**
```bash
# 健康检查
curl https://你的后端域名.zeabur.app/health

# 获取预约列表
curl https://你的后端域名.zeabur.app/api/bookings

# 创建预约
curl -X POST https://你的后端域名.zeabur.app/api/bookings \
  -H "Content-Type: application/json" \
  -d '{
    "id": "test-001",
    "studio": "无影棚1号",
    "date": "2026-01-28",
    "startTime": "10:00",
    "endTime": "12:00",
    "photographer": "测试摄影师",
    "contact": "13800138000",
    "notes": "测试预约"
  }'
```

### 4. 测试多用户同步

1. **打开第一个浏览器窗口**
   - 访问前端地址
   - 登录系统
   - 创建一个预约

2. **打开第二个浏览器窗口（隐身模式）**
   - 访问相同的前端地址
   - 登录系统（可以用不同用户名）
   - 查看是否能看到第一个窗口创建的预约

3. **验证实时同步**
   - 在任一窗口创建/删除预约
   - 另一个窗口应在 30 秒内自动刷新并同步

4. **测试时间冲突**
   - 尝试在相同时间段预约同一个棚
   - 应该提示 "该时间段已被预约"

## 🔍 验证清单

### 后端验证
- [ ] 健康检查返回 `{"status":"ok"}`
- [ ] 可以获取预约列表
- [ ] 可以创建新预约
- [ ] 时间冲突检测正常工作
- [ ] 可以删除预约
- [ ] 数据库表已自动创建

### 前端验证
- [ ] 页面正常加载
- [ ] 可以登录系统
- [ ] 列表视图显示正常
- [ ] 时间轴视图显示正常
- [ ] 可以创建预约
- [ ] 可以删除预约
- [ ] 预约数据持久化（刷新页面后仍存在）

### 多用户同步验证
- [ ] 多个浏览器窗口能看到相同的预约
- [ ] 创建预约后其他窗口能同步显示
- [ ] 删除预约后其他窗口能同步删除
- [ ] 自动刷新功能正常（30秒间隔）

## 🐛 常见问题

### 问题1: 后端部署失败
- 检查 Zeabur 部署日志
- 确认 `DATABASE_URL` 环境变量已设置
- 确认 PostgreSQL 服务正在运行

### 问题2: 前端无法连接后端
- 检查 `app.js` 中的 `API_BASE_URL` 是否正确
- 检查浏览器控制台是否有 CORS 错误
- 确认后端服务正在运行

### 问题3: 数据不同步
- 检查浏览器控制台的网络请求
- 确认 `API_BASE_URL` 不是空字符串
- 检查后端日志是否有错误

### 问题4: 时间冲突检测不工作
- 检查后端日志
- 确认数据库表已正确创建
- 测试 API 端点是否正常响应

## 📞 需要帮助？

如果遇到问题：
1. 查看 Zeabur 部署日志
2. 查看浏览器控制台（F12）
3. 使用测试脚本验证 API
4. 检查数据库连接状态

## 🎉 部署成功标志

当你看到以下情况时，说明部署成功：
- ✅ 后端健康检查返回正常
- ✅ 前端页面正常加载
- ✅ 可以创建和删除预约
- ✅ 多个浏览器窗口数据同步
- ✅ 刷新页面后数据仍然存在
